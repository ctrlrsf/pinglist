<html>
  <head>
    <script src="http://fb.me/react-0.13.0.js"></script>
    <script src="http://fb.me/JSXTransformer-0.13.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  </head>
  <body>
    <h1>Pinglist</h1>

    <div id="hostform"></div>
    <div id="hostlist"></div>

    <script type="text/jsx">
var formatLatency = function(microsecs) {
  return (microsecs / 1e6).toFixed(2) + "ms"
}

var formatStatus = function(statusInt) {
  if (statusInt === 1) {
    return "Online"
  }
  return "Offline"
}



var HostList = React.createClass({
  getInitialState: function() {
    return {
      hostList: {}
    };
  },

  componentDidMount: function() {
    this.loadData();
  },

  loadData: function() {
    $.get(this.props.source, function(result) {
      if (result !== null) {
        var hostList = result
        if (this.isMounted()) {
          this.setState({
            hostList: hostList
          });
        }
      }
    }.bind(this));
    setTimeout(this.loadData, 5000)
  },

  render: function() {
    var keyList = new Array()
    for (var key in this.state.hostList) {
      keyList.push(key)
    }

    if (keyList.length > 0) {
      var hostList = this.state.hostList

      var hostLiNodes = keyList.map(function (key) {
        var host = hostList[key]
        return (
          <Host key={host.Address} address={host.Address} description={host.Description} status={host.Status} latency={host.Latency} />
        );
      });

      return (
        <div>
        {hostLiNodes}
        </div>
      );
      } else {
        return ( <div>No hosts being monitored.</div> );
      }
  }
});

var Host = React.createClass({
  handleDelete: function() {
    console.log("Deleting: " + this.props.address)

    var deleteUrl = apiUrl + "/" + this.props.address

    $.ajax({
      url: deleteUrl,
      type: "DELETE",
      success: function(result) {
        console.log("Deleted successfully.")
      }
    });
  },

  render: function() {
    var offlineColor = "#FF0000"
    var onlineColor = "#00FF00"
    var statusColor

    if (this.props.status === 1) {
      statusColor = onlineColor
    } else {
      statusColor = offlineColor
    }

    var divStyle = {
      color: statusColor,
      fontWeight: "bold",
    }

    return (
      <div className="container" style={{width: "500px", marginLeft: "2em"}}>
        <div className="row">
          <div className="col-md-1">
            <a href="#" onClick={this.handleDelete}>&#x2716;</a>
          </div>
          <div className="col-md-4">
            {this.props.address}
          </div>
          <div className="col-md-3">
            {this.props.description}
          </div>
          <div className="col-md-2" style={divStyle}>
            {formatStatus(this.props.status)}
          </div>
          <div className="col-md-2">
            {formatLatency(this.props.latency)}
          </div>
        </div>
      </div>
    );
  }
});

var HostAddForm = React.createClass({
  handleSubmit: function(e) {
    e.preventDefault();
    var address = React.findDOMNode(this.refs.address).value.trim();
    var description = React.findDOMNode(this.refs.description).value.trim();

    React.findDOMNode(this.refs.address).value = ""
    React.findDOMNode(this.refs.description).value = ""


    if (! address) {
      return;
    }

    var putUrl = this.props.url + "/" + address

    var hostJson = {
      "Address" : address,
      "Description" : description,
    }

    $.ajax({
      url: putUrl,
      type: "PUT",
      contentType: "application/json",
      data: JSON.stringify(hostJson),
      dataType: "json",
      success: function(result) {
        console.log("Host added successfully.")
      }.bind(this)
    });

    return;
  },

  render: function() {
    return (
      <form className="hostAddForm" onSubmit={this.handleSubmit}>
        <input type="text" placeholder="IP or hostname" ref="address" />
        <input type="text" placeholder="Description" ref="description" />
        <input type="submit" value="Add host" />
      </form>
    );
  },
});

var apiUrl = "http://" + window.location.host + "/api/hosts"

React.render(<HostAddForm url={apiUrl} />, document.getElementById("hostform"))
React.render(<HostList source={apiUrl} />, document.getElementById("hostlist"))
    </script>
  </body>
</html>
