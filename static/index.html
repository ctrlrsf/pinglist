<html>
  <head>
    <script src="http://fb.me/react-0.13.0.js"></script>
    <script src="http://fb.me/JSXTransformer-0.13.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  </head>
  <body>
    <h1>Pinglist</h1>

    <div id="hostform"></div>
    <div id="hostlist"></div>

    <script type="text/jsx">
var formatLatency = function(microsecs) {
  return (microsecs / 1e6).toFixed(2) + "ms"
}

var formatStatus = function(statusInt) {
  if (statusInt === 1) {
    return "Online"
  }
  return "Offline"
}



var HostList = React.createClass({
  getInitialState: function() {
    return {
      hostList: []
    };
  },

  componentDidMount: function() {
    this.loadData();
  },

  loadData: function() {
    $.get(this.props.source, function(result) {
      if (result !== null) {
        var hostList = result
        if (this.isMounted()) {
          this.setState({
            hostList: hostList
          });
        }
      }
    }.bind(this));
    setTimeout(this.loadData, 5000)
  },

  render: function() {
    var hostLiNodes = this.state.hostList.map(function (host) {
      return (
        <Host key={host.Address} address={host.Address} status={host.Status} latency={host.Latency} />
      );
    });
    return (
      <div>
      {hostLiNodes}
      </div>
    );
  }
});

var Host = React.createClass({
  render: function() {
    var offlineColor = "#FF0000"
    var onlineColor = "#00FF00"
    var statusColor

    if (this.props.status === 1) {
      statusColor = onlineColor
    } else {
      statusColor = offlineColor
    }

    var divStyle = {
      color: statusColor,
      fontWeight: "bold",
    }

    return (
      <div className="container" style={{width: "500px"}}>
        <div style={divStyle} class="row">
          <div className="col-md-4">
            {this.props.address}
          </div>
          <div className="col-md-4">
            {formatStatus(this.props.status)}
          </div>
          <div className="col-md-4">
            {formatLatency(this.props.latency)}
          </div>
        </div>
      </div>
    );
  }
});

var HostAddForm = React.createClass({
  handleSubmit: function(e) {
    e.preventDefault();
    var address = React.findDOMNode(this.refs.address).value.trim();

    if (! address) {
      return;
    }

    var putUrl=this.props.url + "/" + address

    $.ajax({
      url: putUrl,
      type: "PUT",
      success: function(result) {
        React.findDOMNode(this.refs.address).value = "";
      }.bind(this)
    });

    return;
  },

  render: function() {
    return (
      <form className="hostAddForm" onSubmit={this.handleSubmit}>
        <input type="text" placeholder="IP or hostname" ref="address" />
        <input type="submit" value="Add host" />
      </form>
    );
  },
});

var apiUrl = "http://" + window.location.host + "/api/hosts"

React.render(<HostAddForm url={apiUrl} />, document.getElementById("hostform"))
React.render(<HostList source={apiUrl} />, document.getElementById("hostlist"))
    </script>
  </body>
</html>
